<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack-a-Punchliner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        :root {
            --neon-cyan: #00fff2;
            --neon-pink: #ff00ff;
            --bg-dark: #050b14;
            --bg-panel: #0a1120;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 255, 242, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.05) 0%, transparent 20%);
        }

        .cyber-container {
            background: var(--bg-panel);
            border: 1px solid rgba(0, 255, 242, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 242, 0.1), inset 0 0 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        /* --- STILE KBD (RIPRISTINATO) --- */
        kbd {
            display: inline-block;
            padding: 2px 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--neon-cyan);
            background: rgba(0, 255, 242, 0.05);
            border: 1px solid rgba(0, 255, 242, 0.4);
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0, 255, 242, 0.2);
            margin: 0 4px;
            text-transform: uppercase;
        }

        /* --- ANIMAZIONI PULSANTI --- */
        .cyber-button {
            position: relative;
            background: transparent;
            color: var(--neon-cyan);
            border: 1px solid var(--neon-cyan);
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            overflow: hidden;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .cyber-button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 242, 0.4), transparent);
            transition: all 0.5s;
            z-index: -1;
        }

        .cyber-button:hover:not(:disabled) {
            color: #fff;
            background: rgba(0, 255, 242, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.4), inset 0 0 15px rgba(0, 255, 242, 0.2);
            text-shadow: 0 0 8px #fff;
            border-color: #fff;
        }

        .cyber-button:hover:not(:disabled)::before { left: 100%; }

        .button-primary {
            color: var(--neon-pink) !important;
            border-color: var(--neon-pink) !important;
        }
        .button-primary::before { background: linear-gradient(90deg, transparent, rgba(255, 0, 255, 0.4), transparent); }
        .button-primary:hover:not(:disabled) {
            background: rgba(255, 0, 255, 0.1) !important;
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.5) !important;
            border-color: #fff !important;
        }

        .cyber-toast {
            position: fixed; top: 20px; right: 20px;
            background: var(--bg-panel); border-left: 4px solid var(--neon-cyan);
            color: var(--neon-cyan); padding: 15px 25px; border-radius: 4px;
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.3); z-index: 1001;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            font-size: 0.75rem; pointer-events: none;
        }

        /* Animazione Arancione per Carica DB */
        .button-orange {
            color: #f97316 !important;
            border-color: #f97316 !important;
        }
        .button-orange::before {
            background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.4), transparent) !important;
        }
        .button-orange:hover:not(:disabled) {
            background: rgba(249, 115, 22, 0.1) !important;
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.4) !important;
        }

        /* Animazione Verde per Manuale */
        .button-green {
            color: #22c55e !important;
            border-color: #22c55e !important;
        }
        .button-green::before {
            background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.4), transparent) !important;
        }
        .button-green:hover:not(:disabled) {
            background: rgba(34, 197, 94, 0.1) !important;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4) !important;
        }

        #editorModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 11, 20, 0.98); z-index: 100;
            display: none; overflow-y: auto; padding: 1rem;
        }

        .cyber-input {
            background: rgba(7, 14, 26, 0.8) !important;
            border: 1px solid rgba(30, 41, 59, 0.7) !important;
            color: var(--neon-cyan) !important; outline: none;
        }

        .animate-fade { animation: bounce-in 0.3s ease-out; }
        @keyframes bounce-in { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-5xl md:text-6xl font-extrabold uppercase tracking-wider"
                style="text-shadow: 0 0 10px rgba(0,255,242,0.5); background: linear-gradient(to right, var(--neon-cyan), white, var(--neon-pink)); -webkit-background-clip: text; color: transparent;">
                PACK-A-PUNCHLINER
            </h1>
            <p class="hidden md:block text-cyan-800 mt-4 font-mono uppercase tracking-widest text-sm">
                Premi <kbd class="px-2 py-1 bg-slate-900 border border-cyan-900 rounded text-xs text-cyan-400">SPAZIO</kbd> per generare
            </p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-6">
                <div id="displayArea" class="cyber-container rounded-3xl p-10 min-h-[450px] flex flex-col items-center justify-center gap-4 text-center">
                    <p class="text-slate-600 italic uppercase text-xs">In attesa...</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                    <div class="flex flex-row items-center justify-center gap-4 w-full sm:w-auto">
                        <div class="flex items-center gap-1 cyber-container px-4 py-2 rounded-full h-[58px]">
                            <button onclick="adjustCount(-1)" class="w-8 h-8 flex items-center justify-center text-cyan-500 hover:text-white font-bold text-xl">-</button>
                            <input type="number" id="wordCount" value="1" min="1" max="10"
                                   class="bg-transparent border-none w-10 text-center text-white font-bold text-xl outline-none focus:ring-0">
                            <button onclick="adjustCount(1)" class="w-8 h-8 flex items-center justify-center text-cyan-500 hover:text-white font-bold text-xl">+</button>
                        </div>
                        <button onclick="generate()" class="cyber-button button-primary px-12 py-4 text-lg flex-1 sm:flex-none h-[58px]">GENERA</button>
                    </div>
                    <button onclick="resetDeck()" class="cyber-button px-8 py-4 text-xs h-[58px] w-full sm:w-auto">SHUFFLE</button>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="cyber-container rounded-2xl p-6">
                    <h3 class="text-[10px] text-cyan-500 font-bold uppercase mb-4 tracking-widest">Filtri Categoria</h3>
                    <div id="tagFilters" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="space-y-4">
                    <button onclick="openEditor()" class="cyber-button w-full py-4 text-sm">Apri Database</button>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="exportData()" class="cyber-button py-2 text-[10px]">Export</button>
                        <button onclick="document.getElementById('importFile').click()" class="cyber-button py-2 text-[10px]">Import</button>
                    </div>
                    <button onclick="loadDefaultDB()" class="cyber-button button-orange w-full py-3 text-[10px] border-dashed">Carica DB Default</button>
                    <a href="https://github.com/bonjirum/WGEN/blob/master/README.md" target="_blank" class="cyber-button button-green w-full py-3 text-[10px] mt-2">
                        MANUALE
                    </a>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </main>
    </div>

    <div id="editorModal">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-cyan-500 uppercase tracking-widest">Database Editor</h2>
                <button onclick="closeEditor()" class="w-12 h-12 flex items-center justify-center border border-pink-900 text-pink-500 rounded-full hover:bg-pink-900/20 text-2xl">×</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <div class="lg:col-span-2">
                    <textarea id="newWords" rows="4" placeholder="Mela&#10;Pera&#10;..." class="cyber-input w-full rounded-xl p-4 text-sm font-mono h-32"></textarea>
                </div>
                <div class="space-y-4">
                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Tag Rapidi:</div>
                    <div id="quickSelectTags" class="flex flex-wrap gap-1 mb-2 max-h-24 overflow-y-auto p-2 bg-slate-900/50 rounded-lg"></div>
                    <input type="text" id="newTags" placeholder="Frutta, Dolci, ..." class="cyber-input w-full rounded-xl p-4 text-sm font-bold">
                    <button onclick="addWordsBulk()" class="cyber-button w-full py-4 font-bold">AGGIUNGI</button>
                </div>
            </div>

            <div class="cyber-container rounded-2xl p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
                    <input type="text" id="tableSearch" oninput="handleTableSearch()" placeholder="Cerca..." class="cyber-input w-full sm:w-80 rounded-lg px-4 py-2 text-xs">
                    <div id="archiveTagFilters" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/80">
                            <tr>
                                <th class="p-4 text-cyan-700 font-bold uppercase text-[10px]">Entità</th>
                                <th class="p-4 text-cyan-700 font-bold uppercase text-[10px]">Tag</th>
                                <th class="p-4 text-right text-cyan-700 font-bold uppercase text-[10px]">Azione</th>
                            </tr>
                        </thead>
                        <tbody id="wordTableBody" class="divide-y divide-slate-800/30 text-sm font-mono"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <span id="paginationInfo" class="text-[10px] text-slate-500 font-bold uppercase"></span>
                    <div class="flex gap-2">
                        <button onclick="prevPage()" class="cyber-button px-4 py-1 text-[10px]">Indietro</button>
                        <button onclick="nextPage()" class="cyber-button px-4 py-1 text-[10px]">Avanti</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let words = JSON.parse(localStorage.getItem('myWords')) || [];
        let activeTags = new Set();
        let archiveSearchTags = new Set();
        let currentPage = 1;
        let itemsPerPage = 12;
        let searchQuery = "";
        let currentDeck = [];
        let editingTagIndex = null;

        function save() { localStorage.setItem('myWords', JSON.stringify(words)); }
        function init() { renderTags(); renderArchiveSearchTags(); renderTable(); updateQuickSelect(); }

        async function loadDefaultDB() {
            try {
                const response = await fetch('db-argomenti-v1.json');
                if (!response.ok) throw new Error();
                words = await response.json();
                save(); init(); resetDeck();
                showNotification("DATABASE DEFAULT CARICATO");
            } catch (err) { showNotification("ERR: USA LIVE SERVER PER IL FILE JSON"); }
        }

        function openEditor() { document.getElementById('editorModal').style.display = 'block'; document.body.style.overflow = 'hidden'; init(); }
        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; document.body.style.overflow = 'auto'; }

        function showNotification(m) {
            const t = document.createElement('div'); t.className = 'cyber-toast animate-fade'; t.innerText = m;
            document.body.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3000);
        }

        function resetDeck() { currentDeck = []; showNotification("POOL RESETTATO"); }
        function adjustCount(v) { let i = document.getElementById('wordCount'); let n = parseInt(i.value)+v; if(n>=1 && n<=10) i.value=n; }

        function updateQuickSelect() {
            const container = document.getElementById('quickSelectTags');
            const allTags = new Set();
            words.forEach(w => w.tags.forEach(t => allTags.add(t.toLowerCase())));
            const currentInputTags = document.getElementById('newTags').value.split(',').map(s => s.trim().toLowerCase());
            container.innerHTML = [...allTags].sort().map(t => {
                const isActive = currentInputTags.includes(t);
                return `<button onclick="toggleTagInInput('${t}')"class="text-[11px] px-3 py-1.5 rounded-md border uppercase transition-all ${isActive ? 'bg-cyan-500 text-black border-cyan-300' : 'bg-slate-800 text-cyan-400 border-slate-700'}">${t}</button>`;
            }).join('');
        }

        function toggleTagInInput(tag) {
            const input = document.getElementById('newTags');
            let current = input.value.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
            if (current.includes(tag)) current = current.filter(t => t !== tag);
            else current.push(tag);
            input.value = current.join(', ');
            updateQuickSelect();
        }

        function handleTableSearch() { searchQuery = document.getElementById('tableSearch').value.toLowerCase(); currentPage = 1; renderTable(); }

        function renderArchiveSearchTags() {
            const container = document.getElementById('archiveTagFilters');

            // 1. Contiamo quante volte appare ogni tag nel database
            const tagCounts = {};
            words.forEach(w => {
                w.tags.forEach(t => {
                    const lowerTag = t.toLowerCase();
                    tagCounts[lowerTag] = (tagCounts[lowerTag] || 0) + 1;
                });
            });

            // 2. Otteniamo la lista unica dei tag
            const allTags = Object.keys(tagCounts).sort();

            // 3. Generiamo l'HTML includendo il conteggio tra parentesi
            container.innerHTML = allTags.map(tag => {
                const active = archiveSearchTags.has(tag);
                const count = tagCounts[tag];
                return `
                    <button onclick="toggleArchiveTag('${tag}')"
                        class="px-4 py-2 rounded-lg text-[11px] font-bold border uppercase transition-all
                        ${active ? 'bg-cyan-500 text-black border-cyan-300 shadow-[0_0_10px_rgba(0,255,242,0.4)]' : 'bg-slate-900 text-slate-500 border-slate-800'}">
                        ${tag} (${count})
                    </button>`;
            }).join('');
        }

        function toggleArchiveTag(t) { if(archiveSearchTags.has(t)) archiveSearchTags.delete(t); else archiveSearchTags.add(t); currentPage = 1; renderArchiveSearchTags(); renderTable(); }

        function renderTable() {
            const tbody = document.getElementById('wordTableBody');
            let filtered = [...words].reverse().filter(w => {
                const matchesText = w.text.toLowerCase().includes(searchQuery);
                const matchesTags = archiveSearchTags.size === 0 || [...archiveSearchTags].every(t => w.tags.some(wt => wt.toLowerCase() === t.toLowerCase()));
                return matchesText && matchesTags;
            });
            const paginatedItems = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            const allDatabaseTags = [...new Set(words.flatMap(w => w.tags.map(t => t.toLowerCase())))].sort();
            tbody.innerHTML = paginatedItems.map((w) => {
                const idx = words.findIndex(item => item.text === w.text);
                const isAdding = editingTagIndex === idx;
                return `
                <tr class="hover:bg-cyan-900/5 transition">
                    <td class="p-4 font-bold text-slate-200">${w.text}</td>
                    <td class="p-4">
                        <div class="flex flex-wrap gap-1 items-center">
                            ${w.tags.map(t => `<span class="bg-slate-900 text-cyan-600 px-2 py-0.5 rounded text-[9px] uppercase cursor-pointer" onclick="removeTagFromWord(${idx}, '${t}')">${t} ×</span>`).join('')}
                            ${isAdding ? `<select onchange="confirmInlineTag(${idx}, this.value)" class="bg-slate-800 text-cyan-400 text-[10px] rounded"><option value="">+</option>${allDatabaseTags.filter(t => !w.tags.map(wt=>wt.toLowerCase()).includes(t)).map(t => `<option value="${t}">${t.toUpperCase()}</option>`).join('')}</select>` : `<button onclick="editingTagIndex=${idx};renderTable()" class="text-cyan-800 text-xs">+</button>`}
                        </div>
                    </td>
                    <td class="p-4 text-right"><button onclick="deleteWord(${idx})" class="text-pink-900 hover:text-pink-500 text-[9px] uppercase font-bold">Elimina</button></td>
                </tr>`;
            }).join('');
            document.getElementById('paginationInfo').innerText = `Pagina ${currentPage} di ${Math.ceil(filtered.length/itemsPerPage) || 1}`;
        }

        function confirmInlineTag(idx, val) { if(val) words[idx].tags.push(val); editingTagIndex = null; save(); init(); }
        function removeTagFromWord(wi, t) { words[wi].tags = words[wi].tags.filter(tag => tag !== t); if(words[wi].tags.length === 0) words[wi].tags = ['generale']; save(); init(); }
        function deleteWord(i) { words.splice(i, 1); save(); init(); }
        function prevPage() { if(currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { if(currentPage < Math.ceil(words.length/itemsPerPage)) { currentPage++; renderTable(); } }

        function addWordsBulk() {
            const text = document.getElementById('newWords').value;
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const tagsInput = document.getElementById('newTags').value || 'generale';
            const newTags = tagsInput.split(',').map(t => t.trim().toLowerCase()).filter(t => t);

            let addedCount = 0;
            let updatedCount = 0;

            lines.forEach(lineText => {
                // Cerca se la parola esiste già
                const existingWord = words.find(w => w.text.toLowerCase() === lineText.toLowerCase());

                if (existingWord) {
                    // Se esiste, aggiungi solo i tag che non ha già
                    newTags.forEach(tag => {
                        if (!existingWord.tags.includes(tag)) {
                            existingWord.tags.push(tag);
                            updatedCount++;
                        }
                    });
                } else {
                    // Se non esiste, crea la nuova voce
                    words.push({ text: lineText, tags: [...newTags] });
                    addedCount++;
                }
            });

            document.getElementById('newWords').value = '';
            document.getElementById('newTags').value = '';
            save();
            init();

            showNotification(`AGGIUNTI: ${addedCount} | TAG AGGIORNATI: ${updatedCount}`);
        }

        function renderTags() {
            const container = document.getElementById('tagFilters');

            // 1. Contiamo le occorrenze per ogni tag
            const tagCounts = {};
            words.forEach(w => {
                w.tags.forEach(t => {
                    const lowerTag = t.toLowerCase();
                    tagCounts[lowerTag] = (tagCounts[lowerTag] || 0) + 1;
                });
            });

            // 2. Otteniamo la lista unica dei tag ordinata
            const allTags = Object.keys(tagCounts).sort();

            // 3. Generiamo l'HTML con i numeri e lo stile più grande (px-4 py-2 e text-xs)
            container.innerHTML = allTags.map(t => {
                const active = activeTags.has(t);
                const count = tagCounts[t];
                return `
                    <button onclick="toggleTag('${t}')"
                        class="px-4 py-2 rounded-lg text-xs font-bold border uppercase transition-all hover:border-cyan-500
                        ${active ? 'bg-cyan-600 text-white border-cyan-400 shadow-[0_0_10px_rgba(0,255,242,0.3)]' : 'bg-slate-900 text-slate-500 border-slate-800'}">
                        ${t} (${count})
                    </button>`;
            }).join('');
        }

        function toggleTag(t) {
    if(activeTags.has(t)) activeTags.delete(t);
    else activeTags.add(t);
    resetDeck(); // Forza la rigenerazione del mazzo con i nuovi filtri
    renderTags();
}

function generate() {
    const display = document.getElementById('displayArea');
    const count = parseInt(document.getElementById('wordCount').value);

    // Filtra le parole in base ai tag attivi
    let filtered = activeTags.size > 0
        ? words.filter(w => w.tags.some(t => activeTags.has(t.toLowerCase())))
        : words;

    if(filtered.length === 0) return;

    let results = [];
    for(let i=0; i<count; i++) {
        // Se il mazzo è vuoto O se sono stati cambiati i filtri, ricrealo
        if(currentDeck.length === 0) {
            currentDeck = [...filtered].sort(() => Math.random() - 0.5);
        }

        // Estrai l'elemento. Se per errore è undefined (mazzo finito), rigenera
        let picked = currentDeck.pop();
        if(!picked) {
            currentDeck = [...filtered].sort(() => Math.random() - 0.5);
            picked = currentDeck.pop();
        }
        results.push(picked.text);
    }

    display.innerHTML = results.map(res =>
        `<div class="animate-fade text-4xl md:text-5xl font-extrabold text-white" style="text-shadow: 0 0 10px var(--neon-cyan);">${res}</div>`
    ).join('');
}

        function exportData() { const dl = document.createElement('a'); dl.setAttribute("href", "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(words))); dl.setAttribute("download", "backup.json"); dl.click(); }
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedWords = JSON.parse(e.target.result);
                    if (Array.isArray(importedWords)) {
                        let addedCount = 0;
                        let updatedTagsCount = 0;

                        importedWords.forEach(importedItem => {
                            const existingWord = words.find(w => w.text.toLowerCase() === importedItem.text.toLowerCase());

                            if (existingWord) {
                                // Unisci i tag del file con quelli esistenti evitando duplicati
                                importedItem.tags.forEach(tag => {
                                    const lowerTag = tag.toLowerCase();
                                    if (!existingWord.tags.map(t => t.toLowerCase()).includes(lowerTag)) {
                                        existingWord.tags.push(lowerTag);
                                        updatedTagsCount++;
                                    }
                                });
                            } else {
                                // Aggiungi la parola nuova
                                words.push(importedItem);
                                addedCount++;
                            }
                        });

                        save();
                        init();
                        resetDeck();
                        showNotification(`NUOVE VOCI: ${addedCount} | TAG UNIFICATI: ${updatedTagsCount}`);
                    }
                } catch (err) {
                    showNotification("ERRORE NEL FORMATO DEL FILE");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.addEventListener('keydown', (e) => { if(e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); generate(); } });
        document.getElementById('newTags').addEventListener('input', updateQuickSelect);
        init();
    </script>
</body>
</html>
